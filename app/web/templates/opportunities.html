{% extends "base.html" %}
{% block title %}Oportunidades - FENIX Prospector{% endblock %}

{% block content %}
<div class="space-y-6">
    <div>
        <p class="text-xs font-semibold uppercase tracking-widest text-brand-500 mb-2">Inteligencia</p>
        <h1 class="text-3xl font-extrabold text-gray-900 tracking-tight">Oportunidades</h1>
        <p class="text-gray-500 mt-1 text-sm">Subvenciones, licitaciones publicas y anuncios judiciales del BOE</p>
    </div>

    <!-- Tabs -->
    <div class="border-b border-gray-100">
        <nav class="flex gap-1" id="opp-tabs">
            <button onclick="switchTab('cross')" id="tab-cross"
                    class="tab-btn px-4 py-3 text-sm font-semibold border-b-2 border-brand-500 text-brand-500 transition">
                Consulta Empresa
            </button>
            <button onclick="switchTab('subsidies')" id="tab-subsidies"
                    class="tab-btn px-4 py-3 text-sm font-semibold border-b-2 border-transparent text-gray-400 hover:text-gray-700 transition">
                Subvenciones
            </button>
            <button onclick="switchTab('tenders')" id="tab-tenders"
                    class="tab-btn px-4 py-3 text-sm font-semibold border-b-2 border-transparent text-gray-400 hover:text-gray-700 transition">
                Licitaciones
            </button>
            <button onclick="switchTab('judicial')" id="tab-judicial"
                    class="tab-btn px-4 py-3 text-sm font-semibold border-b-2 border-transparent text-gray-400 hover:text-gray-700 transition">
                Anuncios Judiciales
            </button>
            <button onclick="switchTab('conciliacion')" id="tab-conciliacion"
                    class="tab-btn px-4 py-3 text-sm font-semibold border-b-2 border-transparent text-gray-400 hover:text-gray-700 transition">
                Conciliacion
            </button>
        </nav>
    </div>

    <!-- Cross-reference Search Tab -->
    <div id="panel-cross">
        <div class="card p-6 mb-4">
            <h2 class="text-base font-bold text-gray-900 mb-1">Buscar empresa en todas las fuentes</h2>
            <p class="text-gray-400 text-xs mb-4">Busca por CIF o nombre fiscal si ha recibido subvenciones, licitaciones o tiene concursos de acreedores/embargos</p>
            <form id="cross-form" class="flex gap-3 items-end flex-wrap" onsubmit="return false">
                <div>
                    <label class="block text-[11px] font-semibold text-gray-400 uppercase tracking-wider mb-1">CIF</label>
                    <input type="text" name="cif" placeholder="B12345678"
                           class="rounded-xl border-gray-200 shadow-sm text-sm px-3 py-2 border w-40 bg-[#FAFAF8] focus:border-brand-500 focus:ring-1 focus:ring-brand-500 outline-none">
                </div>
                <div>
                    <label class="block text-[11px] font-semibold text-gray-400 uppercase tracking-wider mb-1">Nombre empresa</label>
                    <input type="text" name="nombre" placeholder="Razon social..."
                           class="rounded-xl border-gray-200 shadow-sm text-sm px-3 py-2 border w-64 bg-[#FAFAF8] focus:border-brand-500 focus:ring-1 focus:ring-brand-500 outline-none">
                </div>
                <button type="button"
                        class="btn-primary px-5 py-2 rounded-xl text-sm font-semibold transition"
                        hx-get="/opportunities/cross-search"
                        hx-target="#cross-results"
                        hx-include="#cross-form">
                    Consultar
                </button>
            </form>
        </div>
        <div id="cross-results">
            <div class="text-center py-12 text-gray-400 text-sm">Introduce un CIF o nombre de empresa para buscar en subvenciones, licitaciones y anuncios judiciales.</div>
        </div>
    </div>

    <!-- Subsidies Tab -->
    <div id="panel-subsidies" class="hidden">
        <div class="flex items-center justify-between mb-4 flex-wrap gap-3">
            <form id="subsidies-form" class="flex gap-3 items-end flex-wrap" onsubmit="return false">
                <div>
                    <label class="block text-[11px] font-semibold text-gray-400 uppercase tracking-wider mb-1">Buscar</label>
                    <input type="text" name="q" placeholder="Palabra clave..."
                           class="rounded-xl border-gray-200 shadow-sm text-sm px-3 py-2 border w-48 bg-[#FAFAF8] focus:border-brand-500 focus:ring-1 focus:ring-brand-500 outline-none"
                           hx-get="/opportunities/subsidies-results"
                           hx-trigger="keyup changed delay:400ms"
                           hx-target="#subsidies-results"
                           hx-include="#subsidies-form">
                </div>
                <div>
                    <label class="block text-[11px] font-semibold text-gray-400 uppercase tracking-wider mb-1">Organismo</label>
                    <input type="text" name="organismo" placeholder="Ministerio..."
                           class="rounded-xl border-gray-200 shadow-sm text-sm px-3 py-2 border w-40 bg-[#FAFAF8] focus:border-brand-500 focus:ring-1 focus:ring-brand-500 outline-none"
                           hx-get="/opportunities/subsidies-results"
                           hx-trigger="keyup changed delay:400ms"
                           hx-target="#subsidies-results"
                           hx-include="#subsidies-form">
                </div>
                <button type="button"
                        class="btn-primary px-4 py-2 rounded-xl text-sm font-semibold transition"
                        hx-get="/opportunities/subsidies-results"
                        hx-target="#subsidies-results"
                        hx-include="#subsidies-form">
                    Buscar
                </button>
                <input type="hidden" name="page" value="1" id="sub-page-input">
            </form>
            <div class="flex items-center gap-3">
                <button type="button" id="btn-fetch-subsidies" onclick="fetchData('subsidies', '/api/opportunities/fetch-subsidies', 'BOE')"
                        class="px-4 py-2 bg-green-600 text-white rounded-xl hover:bg-green-700 text-sm font-semibold transition shadow-sm flex items-center gap-2">
                    <span>Actualizar BOE</span>
                </button>
                <span id="status-subsidies" class="text-[11px] text-gray-400 hidden"></span>
            </div>
        </div>
        <div id="subsidies-results">
            <div class="text-center py-12 text-gray-400 text-sm">Haz clic en Buscar para cargar subvenciones</div>
        </div>
    </div>

    <!-- Tenders Tab -->
    <div id="panel-tenders" class="hidden">
        <div class="flex items-center justify-between mb-4 flex-wrap gap-3">
            <form id="tenders-form" class="flex gap-3 items-end flex-wrap" onsubmit="return false">
                <div>
                    <label class="block text-[11px] font-semibold text-gray-400 uppercase tracking-wider mb-1">Buscar</label>
                    <input type="text" name="q" placeholder="Palabra clave..."
                           class="rounded-xl border-gray-200 shadow-sm text-sm px-3 py-2 border w-48 bg-[#FAFAF8] focus:border-brand-500 focus:ring-1 focus:ring-brand-500 outline-none"
                           hx-get="/opportunities/tenders-results"
                           hx-trigger="keyup changed delay:400ms"
                           hx-target="#tenders-results"
                           hx-include="#tenders-form">
                </div>
                <div>
                    <label class="block text-[11px] font-semibold text-gray-400 uppercase tracking-wider mb-1">Tipo contrato</label>
                    <select name="tipo_contrato"
                            class="rounded-xl border-gray-200 shadow-sm text-sm px-3 py-2 border bg-[#FAFAF8] focus:border-brand-500 focus:ring-1 focus:ring-brand-500 outline-none"
                            hx-get="/opportunities/tenders-results"
                            hx-trigger="change"
                            hx-target="#tenders-results"
                            hx-include="#tenders-form">
                        <option value="">Todos</option>
                        <option value="Obras">Obras</option>
                        <option value="Servicios">Servicios</option>
                        <option value="Suministros">Suministros</option>
                    </select>
                </div>
                <button type="button"
                        class="btn-primary px-4 py-2 rounded-xl text-sm font-semibold transition"
                        hx-get="/opportunities/tenders-results"
                        hx-target="#tenders-results"
                        hx-include="#tenders-form">
                    Buscar
                </button>
                <input type="hidden" name="page" value="1" id="tender-page-input">
            </form>
            <div class="flex items-center gap-3">
                <button type="button" id="btn-fetch-tenders" onclick="fetchData('tenders', '/api/opportunities/fetch-tenders', 'PLACSP')"
                        class="px-4 py-2 bg-green-600 text-white rounded-xl hover:bg-green-700 text-sm font-semibold transition shadow-sm flex items-center gap-2">
                    <span>Actualizar PLACSP</span>
                </button>
                <span id="status-tenders" class="text-[11px] text-gray-400 hidden"></span>
            </div>
        </div>
        <div id="tenders-results">
            <div class="text-center py-12 text-gray-400 text-sm">Haz clic en Buscar para cargar licitaciones</div>
        </div>
    </div>

    <!-- Judicial Tab -->
    <div id="panel-judicial" class="hidden">
        <div class="flex items-center justify-between mb-4 flex-wrap gap-3">
            <form id="judicial-form" class="flex gap-3 items-end flex-wrap" onsubmit="return false">
                <div>
                    <label class="block text-[11px] font-semibold text-gray-400 uppercase tracking-wider mb-1">Buscar</label>
                    <input type="text" name="q" placeholder="Empresa, deudor..."
                           class="rounded-xl border-gray-200 shadow-sm text-sm px-3 py-2 border w-48 bg-[#FAFAF8] focus:border-brand-500 focus:ring-1 focus:ring-brand-500 outline-none"
                           hx-get="/opportunities/judicial-results"
                           hx-trigger="keyup changed delay:400ms"
                           hx-target="#judicial-results"
                           hx-include="#judicial-form">
                </div>
                <div>
                    <label class="block text-[11px] font-semibold text-gray-400 uppercase tracking-wider mb-1">Tipo</label>
                    <select name="tipo"
                            class="rounded-xl border-gray-200 shadow-sm text-sm px-3 py-2 border bg-[#FAFAF8] focus:border-brand-500 focus:ring-1 focus:ring-brand-500 outline-none"
                            hx-get="/opportunities/judicial-results"
                            hx-trigger="change"
                            hx-target="#judicial-results"
                            hx-include="#judicial-form">
                        <option value="">Todos</option>
                        <option value="concurso_acreedores">Concurso de acreedores</option>
                        <option value="embargo">Embargo</option>
                        <option value="procedimiento_judicial">Procedimiento judicial</option>
                    </select>
                </div>
                <button type="button"
                        class="btn-primary px-4 py-2 rounded-xl text-sm font-semibold transition"
                        hx-get="/opportunities/judicial-results"
                        hx-target="#judicial-results"
                        hx-include="#judicial-form">
                    Buscar
                </button>
                <input type="hidden" name="page" value="1" id="judicial-page-input">
            </form>
            <div class="flex items-center gap-3">
                <button type="button" id="btn-fetch-judicial" onclick="fetchData('judicial', '/api/opportunities/fetch-judicial', 'BOE Judicial')"
                        class="px-4 py-2 bg-amber-600 text-white rounded-xl hover:bg-amber-700 text-sm font-semibold transition shadow-sm flex items-center gap-2">
                    <span>Actualizar BOE Judicial</span>
                </button>
                <span id="status-judicial" class="text-[11px] text-gray-400 hidden"></span>
            </div>
        </div>
        <div id="judicial-results">
            <div class="text-center py-12 text-gray-400 text-sm">Haz clic en Buscar para cargar anuncios judiciales</div>
        </div>
    </div>

    <!-- Conciliacion Tab -->
    <div id="panel-conciliacion" class="hidden">
        <div class="card p-6 mb-4">
            <h2 class="text-base font-bold text-gray-900 mb-1">Conciliacion Oportunidades &rarr; Empresas</h2>
            <p class="text-gray-400 text-xs mb-4">Cruza subvenciones y licitaciones con empresas activas del mismo CNAE y provincia</p>
            <form id="conc-form" class="flex gap-3 items-end flex-wrap" onsubmit="return false">
                <div>
                    <label class="block text-[11px] font-semibold text-gray-400 uppercase tracking-wider mb-1">Provincia</label>
                    <select name="provincia"
                            class="rounded-xl border-gray-200 shadow-sm text-sm px-3 py-2 border bg-[#FAFAF8] focus:border-brand-500 focus:ring-1 focus:ring-brand-500 outline-none">
                        <option value="">Todas</option>
                        {% for p in provinces %}
                        <option value="{{ p.nombre }}">{{ p.nombre }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label class="block text-[11px] font-semibold text-gray-400 uppercase tracking-wider mb-1">Tipo</label>
                    <select name="tipo"
                            class="rounded-xl border-gray-200 shadow-sm text-sm px-3 py-2 border bg-[#FAFAF8] focus:border-brand-500 focus:ring-1 focus:ring-brand-500 outline-none">
                        <option value="">Todos</option>
                        <option value="subsidies">Subvenciones</option>
                        <option value="tenders">Licitaciones</option>
                    </select>
                </div>
                <div>
                    <label class="block text-[11px] font-semibold text-gray-400 uppercase tracking-wider mb-1">Buscar</label>
                    <input type="text" name="q" placeholder="Titulo..."
                           class="rounded-xl border-gray-200 shadow-sm text-sm px-3 py-2 border w-48 bg-[#FAFAF8] focus:border-brand-500 focus:ring-1 focus:ring-brand-500 outline-none">
                </div>
                <button type="button" id="conc-search-btn"
                        class="btn-primary px-5 py-2 rounded-xl text-sm font-semibold transition"
                        hx-get="/opportunities/conciliacion-results"
                        hx-target="#conciliacion-results"
                        hx-include="#conc-form">
                    Buscar
                </button>
                <input type="hidden" name="page" value="1" id="conc-page-input">
            </form>
        </div>
        <div id="conciliacion-results">
            <div class="text-center py-12 text-gray-400 text-sm">Selecciona filtros y haz clic en Buscar para cruzar oportunidades con empresas.</div>
        </div>
    </div>
</div>

<script>
function switchTab(tab) {
    document.getElementById('panel-cross').classList.toggle('hidden', tab !== 'cross');
    document.getElementById('panel-subsidies').classList.toggle('hidden', tab !== 'subsidies');
    document.getElementById('panel-tenders').classList.toggle('hidden', tab !== 'tenders');
    document.getElementById('panel-judicial').classList.toggle('hidden', tab !== 'judicial');
    document.getElementById('panel-conciliacion').classList.toggle('hidden', tab !== 'conciliacion');

    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('border-brand-500', 'text-brand-500');
        btn.classList.add('border-transparent', 'text-gray-400');
    });
    const active = document.getElementById('tab-' + tab);
    active.classList.add('border-brand-500', 'text-brand-500');
    active.classList.remove('border-transparent', 'text-gray-400');
}

/* --- Pagination helpers --- */
function goToSubPage(page) {
    document.getElementById('sub-page-input').value = page;
    htmx.trigger(document.querySelector('[hx-target="#subsidies-results"]'), 'click');
}
function goToTenderPage(page) {
    document.getElementById('tender-page-input').value = page;
    htmx.trigger(document.querySelector('[hx-target="#tenders-results"]'), 'click');
}
function goToJudicialPage(page) {
    document.getElementById('judicial-page-input').value = page;
    htmx.trigger(document.querySelector('[hx-get="/opportunities/judicial-results"]'), 'click');
}
function goToConcPage(page) {
    document.getElementById('conc-page-input').value = page;
    htmx.trigger(document.getElementById('conc-search-btn'), 'click');
}

/* --- Fetch / Update buttons --- */
async function fetchData(type, url, label) {
    const btn = document.getElementById('btn-fetch-' + type);
    const status = document.getElementById('status-' + type);
    const origHTML = btn.innerHTML;

    // Disable and show progress
    btn.disabled = true;
    btn.classList.add('opacity-70', 'pointer-events-none');
    btn.innerHTML = '<svg class="animate-spin h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg><span>Actualizando...</span>';

    try {
        const resp = await fetch(url, { method: 'POST' });
        const data = await resp.json();

        // Show success state
        btn.innerHTML = '<svg class="h-4 w-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg><span>Actualizado</span>';
        btn.classList.remove('bg-green-600', 'hover:bg-green-700', 'bg-amber-600', 'hover:bg-amber-700');
        btn.classList.add('bg-gray-500');

        // Show timestamp and count
        const now = new Date();
        const timeStr = now.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
        const dateStr = now.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit' });
        const newCount = data.new !== undefined ? data.new : 0;
        status.textContent = dateStr + ' ' + timeStr + ' â€” ' + newCount + ' nuevos';
        status.classList.remove('hidden');

        // Reload results
        if (type === 'subsidies') {
            htmx.trigger(document.querySelector('[hx-target="#subsidies-results"]'), 'click');
        } else if (type === 'tenders') {
            htmx.trigger(document.querySelector('[hx-target="#tenders-results"]'), 'click');
        } else if (type === 'judicial') {
            htmx.trigger(document.querySelector('[hx-get="/opportunities/judicial-results"]'), 'click');
        }

        // Reset button after 5s
        setTimeout(() => {
            btn.innerHTML = origHTML;
            btn.disabled = false;
            btn.classList.remove('opacity-70', 'pointer-events-none', 'bg-gray-500');
            if (type === 'judicial') {
                btn.classList.add('bg-amber-600', 'hover:bg-amber-700');
            } else {
                btn.classList.add('bg-green-600', 'hover:bg-green-700');
            }
        }, 5000);
    } catch (err) {
        btn.innerHTML = '<span>Error</span>';
        status.textContent = 'Error al actualizar';
        status.classList.remove('hidden');
        setTimeout(() => {
            btn.innerHTML = origHTML;
            btn.disabled = false;
            btn.classList.remove('opacity-70', 'pointer-events-none');
        }, 3000);
    }
}
</script>
{% endblock %}
