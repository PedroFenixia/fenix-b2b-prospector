{% extends "base.html" %}
{% block title %}{{ company.nombre }} - FENIX B2B Prospector{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Back link + Watchlist -->
    <div class="flex items-center justify-between">
        <a href="/search" class="text-brand-500 hover:text-brand-600 text-sm font-medium transition">&larr; Volver a b&uacute;squeda</a>
        <div id="watch-btn">
            {% if watched %}
            <button onclick="toggleWatch({{ company.id }}, false)" class="px-3 py-1.5 border border-brand-500 text-brand-500 rounded-lg text-sm font-semibold hover:bg-brand-50 transition">
                Vigilando
            </button>
            {% else %}
            <button onclick="toggleWatch({{ company.id }}, true)" class="px-3 py-1.5 border border-gray-200 text-gray-500 rounded-lg text-sm font-semibold hover:border-brand-500 hover:text-brand-500 transition">
                Vigilar
            </button>
            {% endif %}
        </div>
    </div>

    <!-- Company Header -->
    <div class="card p-6">
        <div class="flex items-start justify-between flex-wrap gap-4">
            <div>
                <h1 class="text-2xl font-extrabold text-gray-900 tracking-tight">{{ company.nombre }}</h1>
                <div class="flex items-center gap-2 mt-2 flex-wrap">
                    {% if company.forma_juridica %}
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-[11px] font-semibold bg-brand-50 text-brand-600 border border-brand-100">{{ company.forma_juridica }}</span>
                    {% endif %}
                    {% if company.estado == 'activa' %}
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-[11px] font-semibold bg-green-50 text-green-600 border border-green-100">Activa</span>
                    {% elif company.estado == 'disuelta' %}
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-[11px] font-semibold bg-red-50 text-red-600 border border-red-100">Disuelta</span>
                    {% elif company.estado == 'en_liquidacion' %}
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-[11px] font-semibold bg-amber-50 text-amber-600 border border-amber-100">En liquidacion</span>
                    {% else %}
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-[11px] font-semibold bg-gray-50 text-gray-600 border border-gray-100">{{ company.estado }}</span>
                    {% endif %}
                    {% if company.cnae_code %}
                    <span class="text-xs text-gray-400 font-mono">CNAE {{ company.cnae_code }}</span>
                    {% endif %}
                </div>
            </div>
            {% if company.capital_social %}
            <div class="text-right">
                <p class="text-[11px] text-gray-400 uppercase tracking-wider font-semibold">Capital social</p>
                <p class="text-xl font-extrabold text-brand-500 font-mono">{{ company.capital_social|eu }}&euro;</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Data Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Basic Info -->
        <div class="card p-6">
            <h2 class="text-base font-bold text-gray-900 mb-4">Datos basicos</h2>
            <dl class="space-y-3">
                <div>
                    <dt class="text-[11px] text-gray-400 uppercase tracking-wider font-semibold">CIF</dt>
                    <dd class="flex items-center gap-2 mt-1" id="cif-display">
                        <span class="text-sm text-gray-900 font-medium font-mono" id="cif-value">{{ company.cif or 'No disponible' }}</span>
                        <button onclick="editCif()" class="text-[11px] text-brand-500 hover:text-brand-600 font-semibold">Editar</button>
                        {% if not company.cif %}
                        <button onclick="lookupCif({{ company.id }})" id="btn-lookup-cif" class="text-[11px] text-gray-400 hover:text-brand-500 font-semibold">Buscar CIF</button>
                        {% endif %}
                    </dd>
                    <dd class="hidden items-center gap-2 mt-1" id="cif-edit">
                        <input type="text" id="cif-input" value="{{ company.cif or '' }}" placeholder="B12345678"
                               class="rounded-xl border-gray-200 shadow-sm text-sm px-2 py-1 border font-mono w-32 bg-[#FAFAF8] focus:border-brand-500 focus:ring-1 focus:ring-brand-500 outline-none">
                        <button onclick="saveCif({{ company.id }})" class="text-[11px] bg-brand-500 text-white px-2.5 py-1 rounded-lg hover:bg-brand-600 font-semibold">Guardar</button>
                        <button onclick="cancelCif()" class="text-[11px] text-gray-400 hover:text-gray-600 font-medium">Cancelar</button>
                    </dd>
                </div>
                {% if company.domicilio %}
                <div>
                    <dt class="text-[11px] text-gray-400 uppercase tracking-wider font-semibold">Domicilio</dt>
                    <dd class="text-sm text-gray-900 mt-1">{{ company.domicilio }}</dd>
                </div>
                {% endif %}
                {% if company.provincia %}
                <div>
                    <dt class="text-[11px] text-gray-400 uppercase tracking-wider font-semibold">Provincia</dt>
                    <dd class="text-sm text-gray-900 mt-1">{{ company.provincia }}{% if company.localidad %} &middot; {{ company.localidad }}{% endif %}</dd>
                </div>
                {% endif %}
                {% if company.fecha_constitucion %}
                <div>
                    <dt class="text-[11px] text-gray-400 uppercase tracking-wider font-semibold">Fecha constitucion</dt>
                    <dd class="text-sm text-gray-900 mt-1">{{ company.fecha_constitucion }}</dd>
                </div>
                {% endif %}
                <div class="grid grid-cols-2 gap-4 pt-2 border-t border-gray-50">
                    <div>
                        <dt class="text-[11px] text-gray-400 uppercase tracking-wider font-semibold">Primera publicacion</dt>
                        <dd class="text-sm text-gray-900 mt-1 font-mono text-xs">{{ company.fecha_primera_publicacion }}</dd>
                    </div>
                    <div>
                        <dt class="text-[11px] text-gray-400 uppercase tracking-wider font-semibold">Ultima publicacion</dt>
                        <dd class="text-sm text-gray-900 mt-1 font-mono text-xs">{{ company.fecha_ultima_publicacion }}</dd>
                    </div>
                </div>
            </dl>
        </div>

        <!-- Contacto -->
        <div class="card p-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-base font-bold text-gray-900">Contacto</h2>
                <button onclick="enrichWeb({{ company.id }})" id="btn-enrich-web" class="text-[11px] text-gray-400 hover:text-brand-500 font-semibold">Buscar en web</button>
            </div>
            <dl class="space-y-3">
                <div>
                    <dt class="text-[11px] text-gray-400 uppercase tracking-wider font-semibold">Web</dt>
                    <dd class="text-sm mt-1" id="web-value">
                        {% if company.web %}
                        <a href="{{ company.web }}" target="_blank" class="text-brand-500 hover:text-brand-600 underline">{{ company.web|truncate(50) }}</a>
                        {% else %}
                        <span class="text-gray-400">No disponible</span>
                        {% endif %}
                    </dd>
                </div>
                <div>
                    <dt class="text-[11px] text-gray-400 uppercase tracking-wider font-semibold">Email</dt>
                    <dd class="text-sm mt-1" id="email-value">
                        {% if company.email %}
                        <a href="mailto:{{ company.email }}" class="text-brand-500 hover:text-brand-600">{{ company.email }}</a>
                        {% else %}
                        <span class="text-gray-400">No disponible</span>
                        {% endif %}
                    </dd>
                </div>
                <div>
                    <dt class="text-[11px] text-gray-400 uppercase tracking-wider font-semibold">Tel&eacute;fono</dt>
                    <dd class="text-sm mt-1 font-mono" id="phone-value">
                        {% if company.telefono %}
                        <a href="tel:{{ company.telefono }}" class="text-brand-500 hover:text-brand-600">{{ company.telefono }}</a>
                        {% else %}
                        <span class="text-gray-400">No disponible</span>
                        {% endif %}
                    </dd>
                </div>
            </dl>
        </div>
    </div>

    <!-- Objeto Social -->
    <div class="card p-6">
        <h2 class="text-base font-bold text-gray-900 mb-4">Objeto social</h2>
            {% if company.objeto_social %}
            <p class="text-sm text-gray-700 leading-relaxed">{{ company.objeto_social }}</p>
            {% else %}
            <p class="text-gray-400 text-sm">No disponible</p>
            {% endif %}
        </div>
    </div>

    <!-- Officers -->
    <div class="card p-6">
        <h2 class="text-base font-bold text-gray-900 mb-4">Cargos</h2>
        {% if company.officers %}
        <div class="overflow-x-auto">
            <table class="w-full text-sm">
                <thead>
                    <tr class="border-b border-gray-100">
                        <th class="text-left py-3 px-4 text-[11px] font-semibold uppercase tracking-wider text-gray-400">Persona</th>
                        <th class="text-left py-3 px-4 text-[11px] font-semibold uppercase tracking-wider text-gray-400">Cargo</th>
                        <th class="text-left py-3 px-4 text-[11px] font-semibold uppercase tracking-wider text-gray-400">Tipo</th>
                        <th class="text-left py-3 px-4 text-[11px] font-semibold uppercase tracking-wider text-gray-400">Fecha</th>
                    </tr>
                </thead>
                <tbody>
                    {% for officer in company.officers %}
                    <tr class="border-b border-gray-50 hover:bg-[#FAFAF5] transition">
                        <td class="py-3 px-4 text-sm font-medium text-gray-900">{{ officer.nombre_persona }}</td>
                        <td class="py-3 px-4 text-sm text-gray-600">{{ officer.cargo }}</td>
                        <td class="py-3 px-4">
                            {% if officer.tipo_evento == 'nombramiento' %}
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-semibold bg-green-50 text-green-600 border border-green-100">Nombramiento</span>
                            {% elif officer.tipo_evento == 'cese' %}
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-semibold bg-red-50 text-red-600 border border-red-100">Cese</span>
                            {% elif officer.tipo_evento == 'revocacion' %}
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-semibold bg-amber-50 text-amber-600 border border-amber-100">Revocacion</span>
                            {% elif officer.tipo_evento == 'reeleccion' %}
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-semibold bg-blue-50 text-blue-600 border border-blue-100">Reeleccion</span>
                            {% else %}
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-semibold bg-gray-50 text-gray-600 border border-gray-100">{{ officer.tipo_evento }}</span>
                            {% endif %}
                        </td>
                        <td class="py-3 px-4 text-sm text-gray-500 font-mono text-xs">{{ officer.fecha_publicacion }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="text-gray-400 text-sm">No hay cargos registrados</p>
        {% endif %}
    </div>

    <!-- Acts History -->
    <div class="card p-6">
        <h2 class="text-base font-bold text-gray-900 mb-4">Historial de actos mercantiles</h2>
        {% if company.acts %}
        <div class="space-y-2">
            {% for act in company.acts %}
            <div class="border border-gray-100 rounded-xl p-3 hover:bg-[#FAFAF5] transition">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <span class="inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-semibold bg-brand-50 text-brand-600 border border-brand-100">{{ act.tipo_acto }}</span>
                        {% if act.borme_id %}
                        <span class="text-[11px] text-gray-400 font-mono">{{ act.borme_id }}</span>
                        {% endif %}
                    </div>
                    <span class="text-xs text-gray-400 font-mono">{{ act.fecha_publicacion }}</span>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p class="text-gray-400 text-sm">No hay actos registrados</p>
        {% endif %}
    </div>
</div>

<script>
function editCif() {
    document.getElementById('cif-display').classList.add('hidden');
    document.getElementById('cif-edit').classList.remove('hidden');
    document.getElementById('cif-edit').classList.add('flex');
    document.getElementById('cif-input').focus();
}

function cancelCif() {
    document.getElementById('cif-edit').classList.add('hidden');
    document.getElementById('cif-edit').classList.remove('flex');
    document.getElementById('cif-display').classList.remove('hidden');
}

async function saveCif(companyId) {
    const cif = document.getElementById('cif-input').value.trim() || null;
    const resp = await fetch('/api/companies/' + companyId + '/cif', {
        method: 'PATCH',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({cif: cif})
    });
    if (resp.ok) {
        const data = await resp.json();
        document.getElementById('cif-value').textContent = data.cif || 'No disponible';
        cancelCif();
    } else {
        alert('Error al guardar el CIF');
    }
}

async function lookupCif(companyId) {
    var btn = document.getElementById('btn-lookup-cif');
    btn.textContent = 'Buscando...';
    btn.disabled = true;
    try {
        var resp = await fetch('/api/companies/' + companyId + '/lookup-cif', { method: 'POST' });
        var data = await resp.json();
        if (data.cif) {
            document.getElementById('cif-value').textContent = data.cif;
            btn.textContent = 'Encontrado';
            btn.classList.add('text-green-500');
        } else {
            btn.textContent = data.error || 'No encontrado';
        }
    } catch(e) {
        btn.textContent = 'Error';
    }
}

async function enrichWeb(companyId) {
    var btn = document.getElementById('btn-enrich-web');
    btn.textContent = 'Buscando...';
    btn.disabled = true;
    try {
        var resp = await fetch('/api/companies/' + companyId + '/enrich-web', { method: 'POST' });
        var data = await resp.json();
        if (data.web) {
            document.getElementById('web-value').innerHTML = '<a href="' + data.web + '" target="_blank" class="text-brand-500 hover:text-brand-600 underline">' + data.web.substring(0,50) + '</a>';
        }
        if (data.email) {
            document.getElementById('email-value').innerHTML = '<a href="mailto:' + data.email + '" class="text-brand-500 hover:text-brand-600">' + data.email + '</a>';
        }
        if (data.telefono) {
            document.getElementById('phone-value').innerHTML = '<a href="tel:' + data.telefono + '" class="text-brand-500 hover:text-brand-600">' + data.telefono + '</a>';
        }
        if (data.cif) {
            document.getElementById('cif-value').textContent = data.cif;
        }
        btn.textContent = data.web ? 'Encontrado' : 'No encontrado';
        btn.classList.add(data.web ? 'text-green-500' : 'text-red-400');
    } catch(e) {
        btn.textContent = 'Error';
    }
}

async function toggleWatch(companyId, add) {
    if (add) {
        const resp = await fetch('/api/watchlist/' + companyId, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({})
        });
        if (resp.ok) {
            document.getElementById('watch-btn').innerHTML =
                '<button onclick="toggleWatch(' + companyId + ', false)" class="px-3 py-1.5 border border-brand-500 text-brand-500 rounded-lg text-sm font-semibold hover:bg-brand-50 transition">Vigilando</button>';
        }
    } else {
        const resp = await fetch('/api/watchlist/' + companyId, { method: 'DELETE' });
        if (resp.ok) {
            document.getElementById('watch-btn').innerHTML =
                '<button onclick="toggleWatch(' + companyId + ', true)" class="px-3 py-1.5 border border-gray-200 text-gray-500 rounded-lg text-sm font-semibold hover:border-brand-500 hover:text-brand-500 transition">Vigilar</button>';
        }
    }
}
</script>
{% endblock %}
