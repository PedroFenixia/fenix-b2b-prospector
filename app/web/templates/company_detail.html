{% extends "base.html" %}
{% block title %}{{ company.nombre }} - FENIX Prospector{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Back link + Watchlist -->
    <div class="flex items-center justify-between">
        <a href="/search" class="text-brand-500 hover:text-brand-600 text-sm font-medium transition">&larr; Volver a b&uacute;squeda</a>
        <div id="watch-btn">
            {% if watched %}
            <button onclick="toggleWatch({{ company.id }}, false)" class="px-3 py-1.5 border border-brand-500 text-brand-500 rounded-lg text-sm font-semibold hover:bg-brand-50 transition">
                Vigilando
            </button>
            {% else %}
            <button onclick="toggleWatch({{ company.id }}, true)" class="px-3 py-1.5 border border-gray-200 text-gray-500 rounded-lg text-sm font-semibold hover:border-brand-500 hover:text-brand-500 transition">
                Vigilar
            </button>
            {% endif %}
        </div>
    </div>

    <!-- Company Header -->
    <div class="card p-6">
        <div class="flex items-start justify-between flex-wrap gap-4">
            <div>
                <h1 class="text-2xl font-extrabold text-gray-900 tracking-tight">{{ company.nombre }}</h1>
                <div class="flex items-center gap-2 mt-2 flex-wrap">
                    {% if company.forma_juridica %}
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-[11px] font-semibold bg-brand-50 text-brand-600 border border-brand-100">{{ company.forma_juridica }}</span>
                    {% endif %}
                    {% if company.estado == 'activa' %}
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-[11px] font-semibold bg-green-50 text-green-600 border border-green-100">Activa</span>
                    {% elif company.estado == 'disuelta' %}
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-[11px] font-semibold bg-red-50 text-red-600 border border-red-100">Disuelta</span>
                    {% elif company.estado == 'en_liquidacion' %}
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-[11px] font-semibold bg-amber-50 text-amber-600 border border-amber-100">En liquidacion</span>
                    {% else %}
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-[11px] font-semibold bg-gray-50 text-gray-600 border border-gray-100">{{ company.estado }}</span>
                    {% endif %}
                    {% if company.cnae_code %}
                    <span class="text-xs text-gray-400 font-mono">CNAE {{ company.cnae_code }}{% if company.cnae_inferred %} *{% endif %}</span>
                    {% endif %}
                </div>
            </div>
            {% if company.capital_social %}
            <div class="text-right">
                <p class="text-[11px] text-gray-400 uppercase tracking-wider font-semibold">Capital social</p>
                <p class="text-xl font-extrabold text-brand-500 font-mono">{{ company.capital_social|eu }}&euro;</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Solvency Score -->
    <div class="card p-6" id="score-card">
        <div class="flex items-center justify-between mb-3">
            <h2 class="text-base font-bold text-gray-900">Puntuacion de solvencia</h2>
            <button onclick="computeScore({{ company.id }})" id="btn-score" class="text-[11px] text-gray-400 hover:text-brand-500 font-semibold">
                {% if company.score_solvencia is not none %}Recalcular{% else %}Calcular{% endif %}
            </button>
        </div>
        <div class="flex items-center gap-6" id="score-display">
            {% if company.score_solvencia is not none %}
            <div class="relative w-20 h-20">
                <svg class="w-20 h-20 -rotate-90" viewBox="0 0 36 36">
                    <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="#f3f4f6" stroke-width="3"/>
                    <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none"
                          stroke="{% if company.score_solvencia >= 76 %}#22c55e{% elif company.score_solvencia >= 51 %}#eab308{% elif company.score_solvencia >= 26 %}#f97316{% else %}#ef4444{% endif %}"
                          stroke-width="3" stroke-dasharray="{{ company.score_solvencia }}, 100" stroke-linecap="round"/>
                </svg>
                <span class="absolute inset-0 flex items-center justify-center text-lg font-extrabold
                    {% if company.score_solvencia >= 76 %}text-green-600{% elif company.score_solvencia >= 51 %}text-yellow-600{% elif company.score_solvencia >= 26 %}text-orange-500{% else %}text-red-600{% endif %}">
                    {{ company.score_solvencia }}
                </span>
            </div>
            <div>
                {% if company.score_solvencia >= 76 %}
                <p class="text-sm font-bold text-green-600">Muy fiable</p>
                <p class="text-xs text-gray-500 mt-0.5">Empresa con indicadores solidos de solvencia</p>
                {% elif company.score_solvencia >= 51 %}
                <p class="text-sm font-bold text-yellow-600">Fiable</p>
                <p class="text-xs text-gray-500 mt-0.5">Indicadores razonables, riesgo bajo-moderado</p>
                {% elif company.score_solvencia >= 26 %}
                <p class="text-sm font-bold text-orange-500">Riesgo moderado</p>
                <p class="text-xs text-gray-500 mt-0.5">Algunos indicadores negativos detectados</p>
                {% else %}
                <p class="text-sm font-bold text-red-600">Riesgo alto</p>
                <p class="text-xs text-gray-500 mt-0.5">Multiples indicadores negativos</p>
                {% endif %}
            </div>
            {% else %}
            <p class="text-gray-400 text-sm">Pulsa "Calcular" para obtener la puntuacion de solvencia</p>
            {% endif %}
        </div>
    </div>

    <!-- Datos financieros -->
    <div class="card p-6">
        <h2 class="text-base font-bold text-gray-900 mb-4">Datos financieros</h2>
        <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
            <div class="bg-gray-50 rounded-xl p-3">
                <p class="text-[11px] text-gray-400 uppercase tracking-wider font-semibold">CNAE</p>
                <div class="flex items-center gap-1.5">
                    <p class="text-sm font-bold text-gray-900 font-mono">{{ company.cnae_code or '-' }}</p>
                    {% if company.cnae_code and company.cnae_inferred %}
                    <span class="inline-flex items-center px-1.5 py-0.5 rounded text-[9px] font-semibold bg-amber-50 text-amber-600 border border-amber-100" title="Inferido del objeto social, no figura en el BORME">No certificado</span>
                    {% endif %}
                </div>
                {% if cnae_desc %}
                <p class="text-[11px] text-gray-500 mt-0.5">{{ cnae_desc }}</p>
                {% endif %}
            </div>
            <div class="bg-gray-50 rounded-xl p-3">
                <p class="text-[11px] text-gray-400 uppercase tracking-wider font-semibold">Capital social</p>
                <p class="text-sm font-bold text-gray-900">{{ company.capital_social|eu }}&euro;</p>
            </div>
            <div class="bg-gray-50 rounded-xl p-3">
                <p class="text-[11px] text-gray-400 uppercase tracking-wider font-semibold">Empleados</p>
                <p class="text-sm font-bold text-gray-900">{{ company.num_empleados or 'N/D' }}</p>
            </div>
            <div class="bg-gray-50 rounded-xl p-3">
                <p class="text-[11px] text-gray-400 uppercase tracking-wider font-semibold">Facturacion</p>
                <p class="text-sm font-bold text-gray-900">{% if company.facturacion %}{{ company.facturacion|eu }}&euro;{% else %}N/D{% endif %}</p>
            </div>
        </div>
    </div>

    <!-- Data Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Basic Info -->
        <div class="card p-6">
            <h2 class="text-base font-bold text-gray-900 mb-4">Datos basicos</h2>
            <dl class="space-y-3">
                <div>
                    <dt class="text-[11px] text-gray-400 uppercase tracking-wider font-semibold">CIF</dt>
                    <dd class="flex items-center gap-2 mt-1" id="cif-display">
                        <span class="text-sm text-gray-900 font-medium font-mono" id="cif-value">{{ company.cif or 'No disponible' }}</span>
                        <button onclick="editCif()" class="text-[11px] text-brand-500 hover:text-brand-600 font-semibold">Editar</button>
                        <button onclick="lookupCif({{ company.id }})" id="btn-lookup-cif" class="text-[11px] text-gray-400 hover:text-brand-500 font-semibold">
                            {% if company.cif %}Buscar de nuevo{% else %}Buscar CIF{% endif %}
                        </button>
                    </dd>
                    <dd class="hidden items-center gap-2 mt-1" id="cif-edit">
                        <input type="text" id="cif-input" value="{{ company.cif or '' }}" placeholder="B12345678"
                               class="rounded-xl border-gray-200 shadow-sm text-sm px-2 py-1 border font-mono w-32 bg-[#FAFAF8] focus:border-brand-500 focus:ring-1 focus:ring-brand-500 outline-none">
                        <button onclick="saveCif({{ company.id }})" class="text-[11px] bg-brand-500 text-white px-2.5 py-1 rounded-lg hover:bg-brand-600 font-semibold">Guardar</button>
                        <button onclick="cancelCif()" class="text-[11px] text-gray-400 hover:text-gray-600 font-medium">Cancelar</button>
                    </dd>
                </div>
                {% if company.domicilio %}
                <div>
                    <dt class="text-[11px] text-gray-400 uppercase tracking-wider font-semibold">Domicilio</dt>
                    <dd class="text-sm text-gray-900 mt-1">{{ company.domicilio }}</dd>
                </div>
                {% endif %}
                {% if company.provincia %}
                <div>
                    <dt class="text-[11px] text-gray-400 uppercase tracking-wider font-semibold">Provincia</dt>
                    <dd class="text-sm text-gray-900 mt-1">{{ company.provincia }}{% if company.localidad %} &middot; {{ company.localidad }}{% endif %}</dd>
                </div>
                {% endif %}
                {% if company.fecha_constitucion %}
                <div>
                    <dt class="text-[11px] text-gray-400 uppercase tracking-wider font-semibold">Fecha constitucion</dt>
                    <dd class="text-sm text-gray-900 mt-1">{{ company.fecha_constitucion }}</dd>
                </div>
                {% endif %}
                {% if company.datos_registrales %}
                <div>
                    <dt class="text-[11px] text-gray-400 uppercase tracking-wider font-semibold">Datos registrales</dt>
                    <dd class="text-sm text-gray-900 mt-1 font-mono text-xs">{{ company.datos_registrales }}</dd>
                </div>
                {% endif %}
                <div class="grid grid-cols-2 gap-4 pt-2 border-t border-gray-50">
                    <div>
                        <dt class="text-[11px] text-gray-400 uppercase tracking-wider font-semibold">Primera publicacion</dt>
                        <dd class="text-sm text-gray-900 mt-1 font-mono text-xs">{{ company.fecha_primera_publicacion }}</dd>
                    </div>
                    <div>
                        <dt class="text-[11px] text-gray-400 uppercase tracking-wider font-semibold">Ultima publicacion</dt>
                        <dd class="text-sm text-gray-900 mt-1 font-mono text-xs">{{ company.fecha_ultima_publicacion }}</dd>
                    </div>
                </div>
            </dl>
        </div>

        <!-- Contacto -->
        <div class="card p-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-base font-bold text-gray-900">Contacto</h2>
                <button onclick="enrichWeb({{ company.id }})" id="btn-enrich-web" class="text-[11px] text-gray-400 hover:text-brand-500 font-semibold">Buscar contacto</button>
            </div>
            <dl class="space-y-3">
                <div>
                    <dt class="text-[11px] text-gray-400 uppercase tracking-wider font-semibold">Web</dt>
                    <dd class="text-sm mt-1" id="web-value">
                        {% if company.web %}
                        <a href="{{ company.web }}" target="_blank" class="text-brand-500 hover:text-brand-600 underline">{{ company.web|truncate(50) }}</a>
                        {% else %}
                        <span class="text-gray-400">No disponible</span>
                        {% endif %}
                    </dd>
                </div>
                <div>
                    <dt class="text-[11px] text-gray-400 uppercase tracking-wider font-semibold">Email</dt>
                    <dd class="text-sm mt-1" id="email-value">
                        {% if company.email %}
                        <a href="mailto:{{ company.email }}" class="text-brand-500 hover:text-brand-600">{{ company.email }}</a>
                        {% else %}
                        <span class="text-gray-400">No disponible</span>
                        {% endif %}
                    </dd>
                </div>
                <div>
                    <dt class="text-[11px] text-gray-400 uppercase tracking-wider font-semibold">Tel&eacute;fono</dt>
                    <dd class="text-sm mt-1 font-mono" id="phone-value">
                        {% if company.telefono %}
                        <a href="tel:{{ company.telefono }}" class="text-brand-500 hover:text-brand-600">{{ company.telefono }}</a>
                        {% else %}
                        <span class="text-gray-400">No disponible</span>
                        {% endif %}
                    </dd>
                </div>
            </dl>
        </div>
    </div>

    <!-- Objeto Social -->
    <div class="card p-6">
        <h2 class="text-base font-bold text-gray-900 mb-4">Objeto social</h2>
            {% if company.objeto_social %}
            <p class="text-sm text-gray-700 leading-relaxed">{{ company.objeto_social }}</p>
            {% else %}
            <p class="text-gray-400 text-sm">No disponible</p>
            {% endif %}
        </div>
    </div>

    <!-- Officers -->
    <div class="card p-6">
        <h2 class="text-base font-bold text-gray-900 mb-4">Cargos</h2>
        {% if company.officers %}
        <div class="overflow-x-auto">
            <table class="w-full text-sm">
                <thead>
                    <tr class="border-b border-gray-100">
                        <th class="text-left py-3 px-4 text-[11px] font-semibold uppercase tracking-wider text-gray-400">Persona</th>
                        <th class="text-left py-3 px-4 text-[11px] font-semibold uppercase tracking-wider text-gray-400">Cargo</th>
                        <th class="text-left py-3 px-4 text-[11px] font-semibold uppercase tracking-wider text-gray-400">Tipo</th>
                        <th class="text-left py-3 px-4 text-[11px] font-semibold uppercase tracking-wider text-gray-400">Fecha</th>
                    </tr>
                </thead>
                <tbody>
                    {% for officer in company.officers %}
                    <tr class="border-b border-gray-50 hover:bg-[#FAFAF5] transition">
                        <td class="py-3 px-4 text-sm font-medium text-gray-900">{{ officer.nombre_persona|clean_punct }}</td>
                        <td class="py-3 px-4 text-sm text-gray-600">{{ officer.cargo|clean_punct }}</td>
                        <td class="py-3 px-4">
                            {% if officer.tipo_evento == 'nombramiento' %}
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-semibold bg-green-50 text-green-600 border border-green-100">Nombramiento</span>
                            {% elif officer.tipo_evento == 'cese' %}
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-semibold bg-red-50 text-red-600 border border-red-100">Cese</span>
                            {% elif officer.tipo_evento == 'revocacion' %}
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-semibold bg-amber-50 text-amber-600 border border-amber-100">Revocacion</span>
                            {% elif officer.tipo_evento == 'reeleccion' %}
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-semibold bg-blue-50 text-blue-600 border border-blue-100">Reeleccion</span>
                            {% else %}
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-semibold bg-gray-50 text-gray-600 border border-gray-100">{{ officer.tipo_evento }}</span>
                            {% endif %}
                        </td>
                        <td class="py-3 px-4 text-sm text-gray-500 font-mono text-xs">{{ officer.fecha_publicacion }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="text-gray-400 text-sm">No hay cargos registrados</p>
        {% endif %}
    </div>

    <!-- Acts History -->
    <div class="card p-6">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-base font-bold text-gray-900">Historial de actos mercantiles</h2>
            {% if company.acts %}
            <p class="text-xs text-gray-400">{{ company.acts|length }} actos</p>
            {% endif %}
        </div>
        {% if company.acts %}
        <div id="acts-list" class="space-y-2">
            {% for act in company.acts %}
            <div class="act-item border border-gray-100 rounded-xl p-3 hover:bg-[#FAFAF5] transition" {% if loop.index > 10 %}style="display:none"{% endif %}>
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <span class="inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-semibold bg-brand-50 text-brand-600 border border-brand-100">{{ act.tipo_acto }}</span>
                        {% if act.borme_id %}
                        {% if act.source_pdf_url %}
                        <a href="{{ act.source_pdf_url }}" target="_blank" rel="noopener" class="text-[11px] text-brand-500 hover:text-brand-600 font-mono underline" title="Ver BORME PDF">{{ act.borme_id }}</a>
                        {% else %}
                        <span class="text-[11px] text-gray-400 font-mono">{{ act.borme_id }}</span>
                        {% endif %}
                        {% endif %}
                    </div>
                    <span class="text-xs text-gray-400 font-mono">{{ act.fecha_publicacion }}</span>
                </div>
            </div>
            {% endfor %}
        </div>
        {% if company.acts|length > 10 %}
        <div id="acts-pagination" class="flex items-center justify-between mt-4">
            <button type="button" onclick="actsPage(-1)" id="acts-prev"
                    class="px-3 py-1.5 border border-gray-200 rounded-lg text-sm text-gray-600 hover:border-brand-500 hover:text-brand-500 transition opacity-30 pointer-events-none" disabled>
                &larr; Anterior
            </button>
            <span id="acts-page-info" class="text-xs text-gray-400">Pag. 1/{{ ((company.acts|length - 1) // 10) + 1 }}</span>
            <button type="button" onclick="actsPage(1)" id="acts-next"
                    class="px-3 py-1.5 border border-gray-200 rounded-lg text-sm text-gray-600 hover:border-brand-500 hover:text-brand-500 transition">
                Siguiente &rarr;
            </button>
        </div>
        {% endif %}
        {% else %}
        <p class="text-gray-400 text-sm">No hay actos registrados</p>
        {% endif %}
    </div>

    <!-- Matching Opportunities by CNAE -->
    {% if matching_opps and (matching_opps.subsidies or matching_opps.tenders) %}
    <div class="card p-6">
        <h2 class="text-base font-bold text-gray-900 mb-1">Oportunidades por CNAE</h2>
        <p class="text-xs text-gray-400 mb-4">Subvenciones y licitaciones relacionadas con CNAE {{ company.cnae_code }}</p>

        {% if matching_opps.subsidies %}
        <div class="mb-4">
            <h3 class="text-sm font-semibold text-gray-700 mb-2">Subvenciones ({{ matching_opps.subsidies|length }})</h3>
            <div class="space-y-2">
                {% for s in matching_opps.subsidies %}
                <div class="border border-gray-100 rounded-xl p-3 hover:bg-[#FAFAF5] transition">
                    <div class="flex items-start justify-between gap-2">
                        <div class="min-w-0">
                            <p class="text-sm font-medium text-gray-900 line-clamp-2">{{ s.titulo[:120] }}</p>
                            <p class="text-[11px] text-gray-400 mt-1">{{ s.organismo or '' }} &middot; {{ s.fecha_publicacion }}</p>
                        </div>
                        {% if s.url_html %}
                        <a href="{{ s.url_html }}" target="_blank" class="text-brand-500 hover:text-brand-600 text-xs font-semibold whitespace-nowrap">BOE</a>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        {% if matching_opps.tenders %}
        <div>
            <h3 class="text-sm font-semibold text-gray-700 mb-2">Licitaciones ({{ matching_opps.tenders|length }})</h3>
            <div class="space-y-2">
                {% for t in matching_opps.tenders %}
                <div class="border border-gray-100 rounded-xl p-3 hover:bg-[#FAFAF5] transition">
                    <div class="flex items-start justify-between gap-2">
                        <div class="min-w-0">
                            <p class="text-sm font-medium text-gray-900 line-clamp-2">{{ t.titulo[:120] }}</p>
                            <div class="flex items-center gap-2 mt-1">
                                <p class="text-[11px] text-gray-400">{{ t.organismo or '' }} &middot; {{ t.fecha_publicacion }}</p>
                                {% if t.importe_estimado %}
                                <span class="text-[11px] font-semibold text-brand-500">{{ t.importe_estimado|eu }}&euro;</span>
                                {% endif %}
                            </div>
                        </div>
                        {% if t.url_licitacion %}
                        <a href="{{ t.url_licitacion }}" target="_blank" class="text-brand-500 hover:text-brand-600 text-xs font-semibold whitespace-nowrap">PLACSP</a>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
    {% endif %}
</div>

<script>
/* Acts pagination */
let _actsPage = 1;
const _actsPerPage = 10;
function actsPage(dir) {
    const items = document.querySelectorAll('.act-item');
    const totalPages = Math.ceil(items.length / _actsPerPage);
    _actsPage = Math.max(1, Math.min(totalPages, _actsPage + dir));
    const start = (_actsPage - 1) * _actsPerPage;
    const end = start + _actsPerPage;
    items.forEach((el, i) => { el.style.display = (i >= start && i < end) ? '' : 'none'; });
    document.getElementById('acts-page-info').textContent = 'Pag. ' + _actsPage + '/' + totalPages;
    const prev = document.getElementById('acts-prev');
    const next = document.getElementById('acts-next');
    prev.disabled = _actsPage <= 1;
    prev.classList.toggle('opacity-30', _actsPage <= 1);
    prev.classList.toggle('pointer-events-none', _actsPage <= 1);
    next.disabled = _actsPage >= totalPages;
    next.classList.toggle('opacity-30', _actsPage >= totalPages);
    next.classList.toggle('pointer-events-none', _actsPage >= totalPages);
}

function editCif() {
    document.getElementById('cif-display').classList.add('hidden');
    document.getElementById('cif-edit').classList.remove('hidden');
    document.getElementById('cif-edit').classList.add('flex');
    document.getElementById('cif-input').focus();
}

function cancelCif() {
    document.getElementById('cif-edit').classList.add('hidden');
    document.getElementById('cif-edit').classList.remove('flex');
    document.getElementById('cif-display').classList.remove('hidden');
}

async function saveCif(companyId) {
    const cif = document.getElementById('cif-input').value.trim() || null;
    const resp = await fetch('/api/companies/' + companyId + '/cif', {
        method: 'PATCH',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({cif: cif})
    });
    if (resp.ok) {
        const data = await resp.json();
        document.getElementById('cif-value').textContent = data.cif || 'No disponible';
        cancelCif();
    } else {
        alert('Error al guardar el CIF');
    }
}

async function lookupCif(companyId) {
    var btn = document.getElementById('btn-lookup-cif');
    btn.textContent = 'Buscando CIF...';
    btn.disabled = true;
    try {
        var resp = await fetch('/api/companies/' + companyId + '/lookup-cif', { method: 'POST' });
        var data = await resp.json();
        if (resp.status === 401 || resp.status === 403) {
            btn.textContent = data.error || 'Plan requerido';
            btn.classList.add('text-red-400');
            return;
        }
        if (data.cif) {
            document.getElementById('cif-value').textContent = data.cif;
            btn.textContent = 'CIF encontrado';
            btn.classList.add('text-green-500');
        } else {
            btn.textContent = data.error || 'No encontrado';
            btn.classList.add('text-red-400');
        }
    } catch(e) {
        btn.textContent = 'Error';
    }
}

async function enrichWeb(companyId) {
    var btn = document.getElementById('btn-enrich-web');
    btn.textContent = 'Buscando contacto...';
    btn.disabled = true;
    try {
        var resp = await fetch('/api/companies/' + companyId + '/enrich-web', { method: 'POST' });
        var data = await resp.json();
        if (resp.status === 401 || resp.status === 403) {
            btn.textContent = data.error || 'Plan requerido';
            btn.classList.add('text-red-400');
            return;
        }
        if (data.web) {
            document.getElementById('web-value').innerHTML = '<a href="' + data.web + '" target="_blank" class="text-brand-500 hover:text-brand-600 underline">' + data.web.substring(0,50) + '</a>';
        }
        if (data.email) {
            document.getElementById('email-value').innerHTML = '<a href="mailto:' + data.email + '" class="text-brand-500 hover:text-brand-600">' + data.email + '</a>';
        }
        if (data.telefono) {
            document.getElementById('phone-value').innerHTML = '<a href="tel:' + data.telefono + '" class="text-brand-500 hover:text-brand-600">' + data.telefono + '</a>';
        }
        var found = data.web || data.email || data.telefono;
        btn.textContent = found ? 'Contacto encontrado' : 'No encontrado';
        btn.classList.add(found ? 'text-green-500' : 'text-red-400');
    } catch(e) {
        btn.textContent = 'Error';
    }
}

async function computeScore(companyId) {
    var btn = document.getElementById('btn-score');
    btn.textContent = 'Calculando...';
    btn.disabled = true;
    try {
        var resp = await fetch('/api/companies/' + companyId + '/score', { method: 'POST' });
        var data = await resp.json();
        if (data.score !== undefined) {
            // Reload page to show the new score with proper styling
            window.location.reload();
        } else {
            btn.textContent = 'Error';
        }
    } catch(e) {
        btn.textContent = 'Error';
    }
}

async function toggleWatch(companyId, add) {
    if (add) {
        const resp = await fetch('/api/watchlist/' + companyId, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({})
        });
        if (resp.ok) {
            document.getElementById('watch-btn').innerHTML =
                '<button onclick="toggleWatch(' + companyId + ', false)" class="px-3 py-1.5 border border-brand-500 text-brand-500 rounded-lg text-sm font-semibold hover:bg-brand-50 transition">Vigilando</button>';
        }
    } else {
        const resp = await fetch('/api/watchlist/' + companyId, { method: 'DELETE' });
        if (resp.ok) {
            document.getElementById('watch-btn').innerHTML =
                '<button onclick="toggleWatch(' + companyId + ', true)" class="px-3 py-1.5 border border-gray-200 text-gray-500 rounded-lg text-sm font-semibold hover:border-brand-500 hover:text-brand-500 transition">Vigilar</button>';
        }
    }
}
</script>
{% endblock %}
