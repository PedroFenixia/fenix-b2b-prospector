{% extends "base.html" %}
{% block title %}Carga de datos - FENIX B2B Prospector{% endblock %}

{% block content %}
<div class="space-y-6">
    <div>
        <p class="text-xs font-semibold uppercase tracking-widest text-brand-500 mb-2">Pipeline</p>
        <h1 class="text-3xl font-extrabold text-gray-900 tracking-tight">Carga de datos</h1>
        <p class="text-gray-500 mt-1 text-sm">Descarga y procesa publicaciones del BORME, BOE y PLACSP</p>
    </div>

    <!-- Trigger Form -->
    <div class="card p-6">
        <h2 class="text-base font-bold text-gray-900 mb-4">Cargar datos BORME</h2>
        <form id="ingestion-form" class="flex flex-wrap items-end gap-4">
            <div>
                <label class="block text-[11px] font-semibold text-gray-400 uppercase tracking-wider mb-1">Fecha desde</label>
                <input type="date" id="fecha_desde" name="fecha_desde" required
                       class="rounded-xl border-gray-200 shadow-sm text-sm px-3 py-2 border bg-[#FAFAF8] focus:border-brand-500 focus:ring-1 focus:ring-brand-500 outline-none">
            </div>
            <div>
                <label class="block text-[11px] font-semibold text-gray-400 uppercase tracking-wider mb-1">Fecha hasta</label>
                <input type="date" id="fecha_hasta" name="fecha_hasta" required
                       class="rounded-xl border-gray-200 shadow-sm text-sm px-3 py-2 border bg-[#FAFAF8] focus:border-brand-500 focus:ring-1 focus:ring-brand-500 outline-none">
            </div>
            <button type="button" id="btn-ingest"
                    onclick="triggerIngestion()"
                    class="btn-primary px-4 py-2 rounded-xl text-sm font-semibold transition">
                Iniciar carga
            </button>
            <button type="button"
                    onclick="triggerToday()"
                    class="px-4 py-2 bg-gray-800 text-white rounded-xl hover:bg-gray-900 text-sm font-semibold transition shadow-sm">
                Solo hoy
            </button>
            <span id="trigger-status" class="text-sm text-gray-500"></span>
        </form>
    </div>

    <!-- BOE / PLACSP Quick Actions -->
    <div class="card p-6">
        <h2 class="text-base font-bold text-gray-900 mb-4">Otras fuentes</h2>
        <div class="flex flex-wrap gap-3">
            <button class="px-4 py-2 bg-green-600 text-white rounded-xl hover:bg-green-700 text-sm font-semibold transition shadow-sm"
                    hx-post="/api/opportunities/fetch-subsidies"
                    hx-swap="none"
                    hx-on::after-request="this.textContent='Actualizado!'">
                Cargar Subvenciones BOE
            </button>
            <button class="px-4 py-2 bg-green-600 text-white rounded-xl hover:bg-green-700 text-sm font-semibold transition shadow-sm"
                    hx-post="/api/opportunities/fetch-tenders"
                    hx-swap="none"
                    hx-on::after-request="this.textContent='Actualizado!'">
                Cargar Licitaciones PLACSP
            </button>
            <button class="px-4 py-2 bg-amber-600 text-white rounded-xl hover:bg-amber-700 text-sm font-semibold transition shadow-sm"
                    hx-post="/api/opportunities/fetch-judicial"
                    hx-swap="none"
                    hx-on::after-request="this.textContent='Actualizado!'">
                Cargar Judiciales BOE
            </button>
        </div>
    </div>

    <!-- CIF Enrichment -->
    <div class="card p-6">
        <div class="flex items-center justify-between mb-4">
            <div>
                <h2 class="text-base font-bold text-gray-900">Enriquecimiento de CIF</h2>
                <p class="text-xs text-gray-400 mt-0.5">Busca CIF autom&aacute;ticamente para empresas sin CIF (APIEmpresas.es)</p>
            </div>
            <div id="cif-stats" class="text-right">
                <span class="text-xs text-gray-400">Cargando cobertura...</span>
            </div>
        </div>
        <div class="flex flex-wrap items-center gap-3">
            <button id="btn-enrich-cif" onclick="enrichCif()" class="px-4 py-2 bg-gray-800 text-white rounded-xl hover:bg-gray-900 text-sm font-semibold transition shadow-sm">
                Buscar CIF (lote de 50)
            </button>
            <span id="cif-status" class="text-sm text-gray-500"></span>
        </div>
    </div>

    <!-- Web Enrichment -->
    <div class="card p-6">
        <div class="flex items-center justify-between mb-4">
            <div>
                <h2 class="text-base font-bold text-gray-900">Enriquecimiento Web</h2>
                <p class="text-xs text-gray-400 mt-0.5">Busca en Google la web de la empresa y extrae CIF, email y tel&eacute;fono del aviso legal</p>
            </div>
            <div id="web-stats" class="text-right">
                <span class="text-xs text-gray-400">Cargando...</span>
            </div>
        </div>
        <div class="flex flex-wrap items-center gap-3">
            <button id="btn-enrich-web" onclick="enrichWeb()" class="px-4 py-2 bg-gray-800 text-white rounded-xl hover:bg-gray-900 text-sm font-semibold transition shadow-sm">
                Buscar en web (lote de 20)
            </button>
            <span id="web-status" class="text-sm text-gray-500"></span>
        </div>
    </div>

    <!-- Status -->
    <div id="ingestion-status"
         hx-get="/ingestion/status-partial"
         hx-trigger="load, every 3s"
         hx-swap="innerHTML">
        {% include "partials/ingestion_status.html" %}
    </div>
</div>

<script>
async function triggerIngestion() {
    const desde = document.getElementById('fecha_desde').value;
    const hasta = document.getElementById('fecha_hasta').value;
    if (!desde || !hasta) { alert('Selecciona ambas fechas'); return; }

    const statusEl = document.getElementById('trigger-status');
    statusEl.textContent = 'Iniciando...';

    try {
        const resp = await fetch('/api/ingestion/trigger', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({fecha_desde: desde, fecha_hasta: hasta})
        });
        const data = await resp.json();
        statusEl.textContent = data.message || data.error || 'OK';
    } catch(e) {
        statusEl.textContent = 'Error: ' + e.message;
    }
}

async function triggerToday() {
    const statusEl = document.getElementById('trigger-status');
    statusEl.textContent = 'Iniciando...';

    try {
        const resp = await fetch('/api/ingestion/trigger-today', {method: 'POST'});
        const data = await resp.json();
        statusEl.textContent = data.message || data.error || 'OK';
    } catch(e) {
        statusEl.textContent = 'Error: ' + e.message;
    }
}

// Set default dates
const today = new Date().toISOString().split('T')[0];
const weekAgo = new Date(Date.now() - 7 * 86400000).toISOString().split('T')[0];
document.getElementById('fecha_hasta').value = today;
document.getElementById('fecha_desde').value = weekAgo;

// Load CIF stats
(async function() {
    try {
        const resp = await fetch('/api/ingestion/cif-stats');
        const data = await resp.json();
        document.getElementById('cif-stats').innerHTML =
            '<p class="text-sm font-mono"><span class="font-bold text-gray-900">' + data.coverage_pct + '%</span> <span class="text-gray-400">cobertura</span></p>' +
            '<p class="text-[10px] text-gray-400">' + data.with_cif + ' con CIF / ' + data.without_cif + ' sin CIF</p>';
    } catch(e) {}
})();

async function enrichCif() {
    const statusEl = document.getElementById('cif-status');
    statusEl.textContent = 'Buscando CIF...';
    try {
        const resp = await fetch('/api/ingestion/enrich-cif', { method: 'POST' });
        const data = await resp.json();
        if (data.error) {
            statusEl.textContent = data.error;
        } else {
            statusEl.textContent = data.message;
        }
    } catch(e) {
        statusEl.textContent = 'Error: ' + e.message;
    }
}

// Load web stats
(async function() {
    try {
        const resp = await fetch('/api/ingestion/web-stats');
        const data = await resp.json();
        document.getElementById('web-stats').innerHTML =
            '<p class="text-[10px] text-gray-400">' + data.with_web + ' con web / ' + data.with_email + ' con email / ' + data.with_phone + ' con tel</p>';
    } catch(e) {}
})();

async function enrichWeb() {
    const statusEl = document.getElementById('web-status');
    statusEl.textContent = 'Buscando webs...';
    try {
        const resp = await fetch('/api/ingestion/enrich-web', { method: 'POST' });
        const data = await resp.json();
        statusEl.textContent = data.message || data.error || 'OK';
    } catch(e) {
        statusEl.textContent = 'Error: ' + e.message;
    }
}
</script>
{% endblock %}
