{% extends "base.html" %}
{% block title %}Carga de datos - FENIX Prospector{% endblock %}

{% block content %}
<div class="space-y-6">
    <div>
        <p class="text-xs font-semibold uppercase tracking-widest text-brand-500 mb-2">Pipeline</p>
        <h1 class="text-3xl font-extrabold text-gray-900 tracking-tight">Carga de datos</h1>
        <p class="text-gray-500 mt-1 text-sm">Descarga y procesa publicaciones del BORME, BOE y PLACSP</p>
    </div>

    <!-- Trigger Form -->
    <div class="card p-6">
        <h2 class="text-base font-bold text-gray-900 mb-4">Cargar datos BORME</h2>
        <form id="ingestion-form" class="flex flex-wrap items-end gap-4">
            <div>
                <label class="block text-[11px] font-semibold text-gray-400 uppercase tracking-wider mb-1">Fecha desde</label>
                <input type="date" id="fecha_desde" name="fecha_desde" required
                       class="rounded-xl border-gray-200 shadow-sm text-sm px-3 py-2 border bg-[#FAFAF8] focus:border-brand-500 focus:ring-1 focus:ring-brand-500 outline-none">
            </div>
            <div>
                <label class="block text-[11px] font-semibold text-gray-400 uppercase tracking-wider mb-1">Fecha hasta</label>
                <input type="date" id="fecha_hasta" name="fecha_hasta" required
                       class="rounded-xl border-gray-200 shadow-sm text-sm px-3 py-2 border bg-[#FAFAF8] focus:border-brand-500 focus:ring-1 focus:ring-brand-500 outline-none">
            </div>
            <button type="button" id="btn-ingest"
                    onclick="triggerIngestion()"
                    class="btn-primary px-4 py-2 rounded-xl text-sm font-semibold transition">
                Iniciar carga
            </button>
            <button type="button" id="btn-today"
                    onclick="triggerToday()"
                    class="px-4 py-2 bg-gray-800 text-white rounded-xl hover:bg-gray-900 text-sm font-semibold transition shadow-sm">
                Solo hoy
            </button>
            <span id="trigger-status" class="text-sm text-gray-500"></span>
        </form>
        <div id="borme-progress" class="hidden mt-3 rounded-full bg-gray-100 h-2 overflow-hidden">
            <div id="borme-progress-bar" class="h-full bg-brand-500 rounded-full transition-all duration-500" style="width:0%"></div>
        </div>
    </div>

    <!-- BOE / PLACSP Quick Actions -->
    <div class="card p-6">
        <h2 class="text-base font-bold text-gray-900 mb-4">Otras fuentes</h2>
        <div class="space-y-3">
            <div class="fetch-action" id="action-subsidies">
                <div class="flex items-center gap-3">
                    <button onclick="fetchSource('subsidies')"
                            class="fetch-btn px-4 py-2 bg-green-600 text-white rounded-xl hover:bg-green-700 text-sm font-semibold transition shadow-sm min-w-[220px]">
                        Cargar Subvenciones BOE
                    </button>
                    <span class="fetch-result text-sm text-gray-500"></span>
                </div>
                <div class="progress-wrap hidden mt-2 rounded-full bg-gray-100 h-2 overflow-hidden">
                    <div class="progress-bar h-full bg-green-500 rounded-full transition-all duration-500" style="width:0%"></div>
                </div>
            </div>
            <div class="fetch-action" id="action-tenders">
                <div class="flex items-center gap-3">
                    <button onclick="fetchSource('tenders')"
                            class="fetch-btn px-4 py-2 bg-green-600 text-white rounded-xl hover:bg-green-700 text-sm font-semibold transition shadow-sm min-w-[220px]">
                        Cargar Licitaciones PLACSP
                    </button>
                    <span class="fetch-result text-sm text-gray-500"></span>
                </div>
                <div class="progress-wrap hidden mt-2 rounded-full bg-gray-100 h-2 overflow-hidden">
                    <div class="progress-bar h-full bg-green-500 rounded-full transition-all duration-500" style="width:0%"></div>
                </div>
            </div>
            <div class="fetch-action" id="action-judicial">
                <div class="flex items-center gap-3">
                    <button onclick="fetchSource('judicial')"
                            class="fetch-btn px-4 py-2 bg-amber-600 text-white rounded-xl hover:bg-amber-700 text-sm font-semibold transition shadow-sm min-w-[220px]">
                        Cargar Judiciales BOE
                    </button>
                    <span class="fetch-result text-sm text-gray-500"></span>
                </div>
                <div class="progress-wrap hidden mt-2 rounded-full bg-gray-100 h-2 overflow-hidden">
                    <div class="progress-bar h-full bg-amber-500 rounded-full transition-all duration-500" style="width:0%"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Enrichment -->
    <div class="card p-6">
        <div class="flex items-center justify-between mb-4">
            <div>
                <h2 class="text-base font-bold text-gray-900">Enriquecimiento</h2>
                <p class="text-xs text-gray-400 mt-0.5">Busca CIF (Google), web, email y tel&eacute;fono para todas las empresas sin datos</p>
            </div>
            <div id="cif-stats" class="text-right">
                <span class="text-xs text-gray-400">Cargando cobertura...</span>
            </div>
        </div>
        <div id="web-stats" class="mb-3">
            <span class="text-xs text-gray-400">Cargando...</span>
        </div>
        <div class="flex flex-wrap items-center gap-3">
            <button id="btn-enrich" onclick="startEnrichment()" class="px-4 py-2 bg-gray-800 text-white rounded-xl hover:bg-gray-900 text-sm font-semibold transition shadow-sm">
                Iniciar enriquecimiento completo
            </button>
            <button id="btn-stop-enrich" onclick="stopEnrichment()" class="hidden px-4 py-2 bg-red-600 text-white rounded-xl hover:bg-red-700 text-sm font-semibold transition shadow-sm">
                Parar
            </button>
            <span id="enrich-status" class="text-sm text-gray-500"></span>
        </div>
        <!-- Live progress -->
        <div id="enrich-progress-wrap" class="hidden mt-4 space-y-2">
            <div class="flex items-center justify-between text-xs text-gray-500">
                <span id="enrich-phase" class="font-semibold"></span>
                <span id="enrich-pct" class="font-mono"></span>
            </div>
            <div class="rounded-full bg-gray-100 h-2.5 overflow-hidden">
                <div id="enrich-bar" class="h-full bg-gray-800 rounded-full transition-all duration-700" style="width:0%"></div>
            </div>
            <div class="flex items-center justify-between text-[10px] text-gray-400">
                <span id="enrich-detail"></span>
                <span id="enrich-current" class="truncate max-w-[200px]"></span>
            </div>
        </div>
    </div>

    <!-- Status -->
    <div id="ingestion-status"
         hx-get="/ingestion/status-partial"
         hx-trigger="load, every 3s"
         hx-swap="innerHTML">
        {% include "partials/ingestion_status.html" %}
    </div>
</div>

<script>
/* === Progress bar helpers === */
function animateProgress(barEl, wrapEl, durationMs) {
    wrapEl.classList.remove('hidden');
    barEl.style.width = '0%';
    const steps = [10, 25, 40, 55, 65, 75, 82, 88, 92];
    let i = 0;
    const interval = durationMs / steps.length;
    const timer = setInterval(() => {
        if (i < steps.length) { barEl.style.width = steps[i] + '%'; i++; }
        else clearInterval(timer);
    }, interval);
    return timer;
}

function completeProgress(barEl, wrapEl, timer) {
    clearInterval(timer);
    barEl.style.width = '100%';
    setTimeout(() => { wrapEl.classList.add('hidden'); barEl.style.width = '0%'; }, 1500);
}

/* === Otras fuentes (BOE subsidies, PLACSP tenders, Judicial) === */
const sourceConfig = {
    subsidies: { url: '/api/opportunities/fetch-subsidies', label: 'Cargar Subvenciones BOE' },
    tenders:   { url: '/api/opportunities/fetch-tenders',   label: 'Cargar Licitaciones PLACSP' },
    judicial:  { url: '/api/opportunities/fetch-judicial',  label: 'Cargar Judiciales BOE' },
};

async function fetchSource(key) {
    const wrap = document.querySelector('#action-' + key);
    const btn = wrap.querySelector('.fetch-btn');
    const result = wrap.querySelector('.fetch-result');
    const progressWrap = wrap.querySelector('.progress-wrap');
    const progressBar = wrap.querySelector('.progress-bar');
    const cfg = sourceConfig[key];

    btn.disabled = true;
    btn.classList.add('opacity-50');
    btn.textContent = 'Actualizando...';
    result.textContent = '';
    const timer = animateProgress(progressBar, progressWrap, 15000);

    try {
        const resp = await fetch(cfg.url, { method: 'POST' });
        if (!resp.ok) {
            const errData = await resp.json().catch(() => ({}));
            throw new Error(errData.error || 'Error del servidor (' + resp.status + ')');
        }
        const data = await resp.json();
        completeProgress(progressBar, progressWrap, timer);
        const fetched = data.fetched || 0;
        const newCount = data.new || 0;
        const now = new Date().toLocaleString('es-ES', {hour:'2-digit',minute:'2-digit',day:'2-digit',month:'2-digit'});
        result.innerHTML = '<span class="text-green-600 font-semibold">&#10003; Actualizado</span> &mdash; ' + fetched + ' encontrados, ' + newCount + ' nuevos <span class="text-gray-400 text-xs ml-2">' + now + '</span>';
        btn.textContent = cfg.label;
    } catch(e) {
        completeProgress(progressBar, progressWrap, timer);
        result.innerHTML = '<span class="text-red-600 font-semibold">Error:</span> ' + e.message;
        btn.textContent = cfg.label;
    } finally {
        btn.disabled = false;
        btn.classList.remove('opacity-50');
    }
}

/* === BORME Ingestion === */
async function triggerIngestion() {
    const desde = document.getElementById('fecha_desde').value;
    const hasta = document.getElementById('fecha_hasta').value;
    if (!desde || !hasta) { alert('Selecciona ambas fechas'); return; }
    await _runBorme('/api/ingestion/trigger', 'POST',
        JSON.stringify({fecha_desde: desde, fecha_hasta: hasta}), 'btn-ingest');
}

async function triggerToday() {
    await _runBorme('/api/ingestion/trigger-today', 'POST', null, 'btn-today');
}

async function _runBorme(url, method, body, btnId) {
    const statusEl = document.getElementById('trigger-status');
    const btn = document.getElementById(btnId);
    const progressWrap = document.getElementById('borme-progress');
    const progressBar = document.getElementById('borme-progress-bar');
    const origText = btn.textContent;

    btn.disabled = true;
    btn.classList.add('opacity-50');
    btn.textContent = 'Cargando...';
    statusEl.textContent = '';
    const headers = body ? {'Content-Type': 'application/json'} : {};
    const timer = animateProgress(progressBar, progressWrap, 30000);

    try {
        const resp = await fetch(url, { method, headers, body });
        const data = await resp.json();
        completeProgress(progressBar, progressWrap, timer);
        const now = new Date().toLocaleString('es-ES', {hour:'2-digit',minute:'2-digit',day:'2-digit',month:'2-digit'});
        statusEl.innerHTML = data.error
            ? '<span class="text-red-600">' + data.error + '</span>'
            : '<span class="text-green-600 font-semibold">&#10003; Actualizado</span> &mdash; ' + (data.message || 'OK') + ' <span class="text-gray-400 text-xs ml-2">' + now + '</span>';
    } catch(e) {
        completeProgress(progressBar, progressWrap, timer);
        statusEl.innerHTML = '<span class="text-red-600">Error: ' + e.message + '</span>';
    } finally {
        btn.textContent = origText;
        btn.disabled = false;
        btn.classList.remove('opacity-50');
    }
}

// Set default dates
const today = new Date().toISOString().split('T')[0];
const weekAgo = new Date(Date.now() - 7 * 86400000).toISOString().split('T')[0];
document.getElementById('fecha_hasta').value = today;
document.getElementById('fecha_desde').value = weekAgo;

// Load CIF stats
(async function() {
    try {
        const resp = await fetch('/api/ingestion/cif-stats');
        const data = await resp.json();
        document.getElementById('cif-stats').innerHTML =
            '<p class="text-sm font-mono"><span class="font-bold text-gray-900">' + data.coverage_pct + '%</span> <span class="text-gray-400">cobertura CIF</span></p>' +
            '<p class="text-[10px] text-gray-400">' + data.with_cif + ' con CIF / ' + data.without_cif + ' sin CIF</p>';
    } catch(e) {}
})();

// Load web stats
(async function() {
    try {
        const resp = await fetch('/api/ingestion/web-stats');
        const data = await resp.json();
        document.getElementById('web-stats').innerHTML =
            '<p class="text-[10px] text-gray-400">' + data.with_web + ' con web / ' + data.with_email + ' con email / ' + data.with_phone + ' con tel</p>';
    } catch(e) {}
})();

/* === Enrichment === */
let _enrichPollTimer = null;

function showRunningState() {
    document.getElementById('btn-enrich').textContent = 'En ejecucion...';
    document.getElementById('btn-enrich').disabled = true;
    document.getElementById('btn-enrich').classList.add('opacity-50');
    document.getElementById('btn-stop-enrich').classList.remove('hidden');
    document.getElementById('enrich-progress-wrap').classList.remove('hidden');
    if (!_enrichPollTimer) _enrichPollTimer = setInterval(pollEnrichment, 3000);
}

function showIdleState() {
    document.getElementById('btn-enrich').textContent = 'Iniciar enriquecimiento completo';
    document.getElementById('btn-enrich').disabled = false;
    document.getElementById('btn-enrich').classList.remove('opacity-50');
    document.getElementById('btn-stop-enrich').classList.add('hidden');
    if (_enrichPollTimer) { clearInterval(_enrichPollTimer); _enrichPollTimer = null; }
    setTimeout(() => document.getElementById('enrich-progress-wrap').classList.add('hidden'), 2000);
}

function updateEnrichUI(data) {
    const phase = data.phase || '';
    const phaseEl = document.getElementById('enrich-phase');
    const barEl = document.getElementById('enrich-bar');
    const pctEl = document.getElementById('enrich-pct');
    const detailEl = document.getElementById('enrich-detail');
    const currentEl = document.getElementById('enrich-current');

    let attempted = 0, total = 0, found = 0, label = '';
    if (phase === 'cif') {
        attempted = data.cif_attempted || 0;
        total = data.cif_total || 1;
        found = data.cif_found || 0;
        label = 'Fase 1: CIF';
    } else if (phase === 'web') {
        attempted = data.web_attempted || 0;
        total = data.web_total || 1;
        found = data.web_found || 0;
        label = 'Fase 2: Web';
    }

    const pct = total > 0 ? Math.round((attempted / total) * 100) : 0;
    phaseEl.textContent = label;
    barEl.style.width = pct + '%';
    pctEl.textContent = pct + '% (' + attempted + '/' + total + ')';
    detailEl.textContent = 'Encontrados: ' + found + ' | Errores: ' + (data.errors || 0);
    currentEl.textContent = data.current_company || '';
}

async function pollEnrichment() {
    try {
        const resp = await fetch('/api/ingestion/enrichment-status');
        const data = await resp.json();
        if (data.running) {
            updateEnrichUI(data);
            // Also refresh CIF/web stats
            try {
                const r2 = await fetch('/api/ingestion/cif-stats');
                const d2 = await r2.json();
                document.getElementById('cif-stats').innerHTML =
                    '<p class="text-sm font-mono"><span class="font-bold text-gray-900">' + d2.coverage_pct + '%</span> <span class="text-gray-400">cobertura CIF</span></p>' +
                    '<p class="text-[10px] text-gray-400">' + d2.with_cif + ' con CIF / ' + d2.without_cif + ' sin CIF</p>';
            } catch(e) {}
        } else {
            showIdleState();
            document.getElementById('enrich-status').textContent = data.phase === 'done' ? 'Completado' : (data.phase === 'stopped' ? 'Detenido' : '');
        }
    } catch(e) {}
}

// Check on page load
(async function() {
    try {
        const resp = await fetch('/api/ingestion/enrichment-status');
        const data = await resp.json();
        if (data.running) {
            showRunningState();
            updateEnrichUI(data);
            document.getElementById('enrich-status').textContent = 'Proceso en segundo plano activo';
        }
    } catch(e) {}
})();

async function startEnrichment() {
    const statusEl = document.getElementById('enrich-status');
    try {
        const resp = await fetch('/api/ingestion/enrich-cif', { method: 'POST' });
        const data = await resp.json();
        if (data.error) {
            statusEl.textContent = data.error;
        } else {
            statusEl.textContent = data.message;
            showRunningState();
        }
    } catch(e) {
        statusEl.textContent = 'Error: ' + e.message;
    }
}

async function stopEnrichment() {
    const statusEl = document.getElementById('enrich-status');
    try {
        const resp = await fetch('/api/ingestion/stop-enrichment', { method: 'POST' });
        const data = await resp.json();
        statusEl.textContent = data.message || data.error;
        showIdleState();
    } catch(e) {
        statusEl.textContent = 'Error: ' + e.message;
    }
}
</script>
{% endblock %}
