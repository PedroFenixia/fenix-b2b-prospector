{% extends "base.html" %}
{% block title %}Ingesta BORME - FENIX Prospector{% endblock %}

{% block content %}
<div class="space-y-6">
    <div>
        <h1 class="text-3xl font-bold text-gray-900">Ingesta de Datos BORME</h1>
        <p class="text-gray-500 mt-1">Descarga y procesa publicaciones del Boletin Oficial del Registro Mercantil</p>
    </div>

    <!-- Trigger Form -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
        <h2 class="text-lg font-semibold text-gray-900 mb-4">Ejecutar Ingesta</h2>
        <form id="ingestion-form" class="flex flex-wrap items-end gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Fecha desde</label>
                <input type="date" id="fecha_desde" name="fecha_desde" required
                       class="rounded-lg border-gray-300 shadow-sm focus:border-brand-500 focus:ring-brand-500 text-sm px-3 py-2 border">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Fecha hasta</label>
                <input type="date" id="fecha_hasta" name="fecha_hasta" required
                       class="rounded-lg border-gray-300 shadow-sm focus:border-brand-500 focus:ring-brand-500 text-sm px-3 py-2 border">
            </div>
            <button type="button" id="btn-ingest"
                    onclick="triggerIngestion()"
                    class="px-4 py-2 bg-brand-600 text-white rounded-lg hover:bg-brand-700 text-sm font-medium">
                Iniciar Ingesta
            </button>
            <button type="button"
                    onclick="triggerToday()"
                    class="px-4 py-2 bg-gray-800 text-white rounded-lg hover:bg-gray-900 text-sm font-medium">
                Solo Hoy
            </button>
            <span id="trigger-status" class="text-sm text-gray-500"></span>
        </form>
    </div>

    <!-- Status -->
    <div id="ingestion-status"
         hx-get="/ingestion/status-partial"
         hx-trigger="load, every 3s"
         hx-swap="innerHTML">
        {% include "partials/ingestion_status.html" %}
    </div>
</div>

<script>
async function triggerIngestion() {
    const desde = document.getElementById('fecha_desde').value;
    const hasta = document.getElementById('fecha_hasta').value;
    if (!desde || !hasta) { alert('Selecciona ambas fechas'); return; }

    const statusEl = document.getElementById('trigger-status');
    statusEl.textContent = 'Iniciando...';

    try {
        const resp = await fetch('/api/ingestion/trigger', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({fecha_desde: desde, fecha_hasta: hasta})
        });
        const data = await resp.json();
        statusEl.textContent = data.message || data.error || 'OK';
    } catch(e) {
        statusEl.textContent = 'Error: ' + e.message;
    }
}

async function triggerToday() {
    const statusEl = document.getElementById('trigger-status');
    statusEl.textContent = 'Iniciando...';

    try {
        const resp = await fetch('/api/ingestion/trigger-today', {method: 'POST'});
        const data = await resp.json();
        statusEl.textContent = data.message || data.error || 'OK';
    } catch(e) {
        statusEl.textContent = 'Error: ' + e.message;
    }
}

// Set default dates
const today = new Date().toISOString().split('T')[0];
const weekAgo = new Date(Date.now() - 7 * 86400000).toISOString().split('T')[0];
document.getElementById('fecha_hasta').value = today;
document.getElementById('fecha_desde').value = weekAgo;
</script>
{% endblock %}
