<!-- Ingestion status partial (HTMX swappable, polled every 3s) -->

{% if status.get('is_running', false) %}
<div class="card p-6 mb-6 border-brand-200 bg-brand-50">
    <div class="flex items-center gap-3 mb-3">
        <div class="animate-spin h-5 w-5 border-2 border-brand-500 border-t-transparent rounded-full"></div>
        <h3 class="text-base font-bold text-brand-800">Carga en curso</h3>
    </div>
    <p class="text-sm text-brand-700">
        Procesando fecha: <strong class="font-mono">{{ status.get('current_date', '...') }}</strong>
    </p>
    {% if status.get('total') %}
    <div class="mt-3 w-full bg-brand-100 rounded-full h-1.5">
        {% set pct = (status.get('processed', 0) / status.get('total', 1) * 100) | int %}
        <div class="bg-brand-500 h-1.5 rounded-full transition-all" style="width: {{ pct }}%"></div>
    </div>
    <p class="text-xs text-brand-600 mt-1 font-mono">{{ status.get('processed', 0) }} / {{ status.get('total', 0) }} dias</p>
    {% endif %}
</div>
{% endif %}

<!-- Recent jobs -->
<div class="card p-6">
    <h2 class="text-base font-bold text-gray-900 mb-4">Historial de cargas</h2>
    {% if recent_jobs %}
    <div class="overflow-x-auto">
        <table class="w-full text-sm">
            <thead>
                <tr class="border-b border-gray-100">
                    <th class="text-left py-3 px-3 text-[11px] font-semibold uppercase tracking-wider text-gray-400">Fecha BORME</th>
                    <th class="text-left py-3 px-3 text-[11px] font-semibold uppercase tracking-wider text-gray-400">Estado</th>
                    <th class="text-left py-3 px-3 text-[11px] font-semibold uppercase tracking-wider text-gray-400">PDFs</th>
                    <th class="text-left py-3 px-3 text-[11px] font-semibold uppercase tracking-wider text-gray-400">Nuevas</th>
                    <th class="text-left py-3 px-3 text-[11px] font-semibold uppercase tracking-wider text-gray-400">Actualizadas</th>
                    <th class="text-left py-3 px-3 text-[11px] font-semibold uppercase tracking-wider text-gray-400">Actos</th>
                    <th class="text-left py-3 px-3 text-[11px] font-semibold uppercase tracking-wider text-gray-400">Error</th>
                </tr>
            </thead>
            <tbody>
                {% for job in recent_jobs %}
                <tr class="border-b border-gray-50 hover:bg-[#FAFAF5] transition">
                    <td class="py-3 px-3 text-sm text-gray-900 font-mono text-xs">{{ job.fecha_borme }}</td>
                    <td class="py-3 px-3">
                        {% if job.status == 'completed' %}
                        <span class="inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-semibold bg-green-50 text-green-600 border border-green-100">OK</span>
                        {% elif job.status == 'failed' %}
                        <span class="inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-semibold bg-red-50 text-red-600 border border-red-100">Error</span>
                        {% else %}
                        <span class="inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-semibold bg-amber-50 text-amber-600 border border-amber-100">{{ job.status }}</span>
                        {% endif %}
                    </td>
                    <td class="py-3 px-3 text-sm text-gray-600 font-mono text-xs">{{ job.pdfs_found }}/{{ job.pdfs_downloaded }}/{{ job.pdfs_parsed }}</td>
                    <td class="py-3 px-3 text-sm text-gray-700 font-mono text-xs">{{ job.companies_new }}</td>
                    <td class="py-3 px-3 text-sm text-gray-700 font-mono text-xs">{{ job.companies_updated }}</td>
                    <td class="py-3 px-3 text-sm text-gray-700 font-mono text-xs">{{ job.acts_created }}</td>
                    <td class="py-3 px-3 text-sm text-red-500 truncate max-w-[200px] text-xs">{{ job.error_message or '' }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <p class="text-gray-400 text-sm">No se ha ejecutado ninguna carga todavia.</p>
    <p class="text-gray-300 text-xs mt-1">Usa el formulario de arriba para iniciar una carga de datos.</p>
    {% endif %}
</div>
